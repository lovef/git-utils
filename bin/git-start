#!/usr/bin/env bash

# TODO: evaluate source "$(git --exec-path)/git-sh-setup"


# https://stackoverflow.com/a/13400237/1020871
# https://stackoverflow.com/a/5476278/1020871
while getopts ":hs" flag; do
case "$flag" in
    h) help=true;;
    s) sync=true;;
    :)  printf "\nmissing argument for -%s\n" "$OPTARG" >&2
        help=true
        ;;
    \?) printf "\nillegal option: -%s\n" "$OPTARG" >&2
        help=true
        ;;
esac
done

newBranch=${@:$OPTIND:1}

remote="origin"
baseBranch="master"
remoteBranch="$remote/$baseBranch"

usage="
usage: $(basename "$0") [options] newBranch

    Starts a new branch from the base branch.

    Base branch is
        $remote $baseBranch if it exists, else
        $baseBranch

where:
    -h  show this help text
    -s  sync default branch"

if [ "$help" = true ] ; then
    echo "$usage" >&2
    exit 1
fi

if [ -z "$newBranch" ]; then
    echo
    echo "no branch name provided"
    echo "$usage" >&2
    exit 1
fi

if !(git remote | grep $remote > /dev/null); then
  unset remote
fi

if [ "$sync" = true ] && [ -n "$remote" ] ; then
    git fetch $remote $baseBranch
fi

if [ -n "$remote" ]; then
    baseBranch=$remote/$baseBranch
fi

git checkout -b $newBranch $baseBranch

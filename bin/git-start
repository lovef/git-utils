#!/usr/bin/env bash

# https://github.com/git/git/blob/master/git-rebase.sh
remote="origin"
sourceBranch="master"
OPTIONS_KEEPDASHDASH=
OPTIONS_SPEC="\
git start [options] <branch> [<source-branch>]
--
  Starts a new branch.

  Available options are
d,default-branch!  start from default branch ($remote $sourceBranch or $sourceBranch)
s,sync!            sync default branch (if using default branch) before start
"

# https://www.kernel.org/pub/software/scm/git/docs/git-sh-setup.html
. "$(git --exec-path)/git-sh-setup"

total_argc=$#
while test $# != 0
do
	case "$1" in
	-d) useDefault=true;;
	-s) sync=true;;
	--)
		shift
		break
		;;
	esac
	shift
done
# One or two positional arguments
test $# -gt 2 && usage

newBranch=$1
ref=HEAD
sourceBranch=${2:-$sourceBranch}

if !(git rev-parse --verify "$remote/$sourceBranch" &> /dev/null); then
    unset remote
fi

if [ "$useDefault" = true ] || [ -n "$2" ] ; then
  ref=$sourceBranch
  if [ -n "$remote" ] && [ ! -n "$2" ]; then
    ref=$remote/$ref
  fi
fi

if [ "$sync" = true ] && [ "$useDefault" = true ] && [ -n "$remote" ] ; then
  git fetch $remote $sourceBranch
fi

git checkout --no-track -b $newBranch $ref
